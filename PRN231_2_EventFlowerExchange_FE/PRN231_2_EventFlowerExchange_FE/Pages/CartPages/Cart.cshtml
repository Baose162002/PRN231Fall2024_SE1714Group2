@page "/Cart"
@model PRN231_2_EventFlowerExchange_FE.Pages.CartPages.CartModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <form method="post">
        @Html.AntiForgeryToken()
    </form>

    <div class="container mx-auto px-4 py-6">
        <h2 class="text-3xl font-bold text-black mb-8">Your Cart</h2>
        <div id="cart-container">
            @if (Model.CartItems != null && Model.CartItems.Count > 0)
            {
                <table class="w-full table-auto border-collapse border border-gray-200">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">Product</th>
                            <th class="px-4 py-2">Quantity</th>
                            <th class="px-4 py-2">Price</th>
                            <th class="px-4 py-2">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.CartItems)
                        {
                            var totalPrice = item.PricePerUnit * item.Quantity;
                            <tr>
                                <td class="border px-4 py-2">@item.Name</td>
                                <td class="border px-4 py-2">
                                    <input type="number" value="@item.Quantity" min="1"
                                           onchange="updateQuantity('@item.FlowerId', this.value)"
                                           class="w-16 text-center">

                                </td>
                                <td class="border px-4 py-2">$@item.PricePerUnit.ToString("F2")</td>
                                <td class="border px-4 py-2">$@totalPrice.ToString("F2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>Your cart is empty.</p>
            }
        </div>
        <div class="mt-6">
            <button id="order-button" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">
                Order
            </button>
        </div>
    </div>

    <script>
        function updateQuantity(flowerId, quantity) {
            fetch('@Url.Page("Cart", "UpdateQuantity")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ flowerId, quantity })
            })
                .then(response => response.json())
                .then(updatedCart => {
                    cartItems = updatedCart;
                    renderCart();
                    saveCartItemsToCookie(cartItems); // Lưu giỏ hàng vào cookie
                    updateCartCount(); // Cập nhật số lượng giỏ hàng
                })
                .catch(error => console.error('Error updating quantity:', error));
        }


        function saveCartItemsToCookie(cartItems) {
            document.cookie = `cartItems=${encodeURIComponent(JSON.stringify(cartItems))}; path=/`;
        }

        document.getElementById('order-button').addEventListener('click', placeOrder);

        function placeOrder() {
            fetch('@Url.Page("Cart", "Order")', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('Order placed successfully!');
                        // Xóa giỏ hàng sau khi đặt hàng
                        document.getElementById('cart-container').innerHTML = '<p>Your cart is empty.</p>';
                    } else {
                        alert('Failed to place order. Please try again.');
                    }
                })
                .catch(error => console.error('Error placing order:', error));
        }
    </script>
</body>
</html>
